# 测试运行指南

## 概述

本项目使用统一的测试运行脚本 `run_test.sh`，支持多环境测试执行，基于 uv 依赖管理和 pytest 测试框架，自动生成 Allure 和 HTML 测试报告。

## 快速开始

### 基本用法

```bash
# 默认开发环境执行
./run_test.sh

# 指定环境执行
./run_test.sh <环境名>

# 带额外参数执行
./run_test.sh <环境名> [pytest参数...]
```

### 使用示例

```bash
# 开发环境：运行所有测试
./run_test.sh
./run_test.sh dev

# 测试环境：运行回归和API测试
./run_test.sh test

# 生产环境：只运行冒烟测试
./run_test.sh prod

# CI环境：并行运行所有测试
./run_test.sh ci

# 带额外参数的示例
./run_test.sh dev -v                    # 详细输出
./run_test.sh prod -m smoke             # 只运行冒烟测试
./run_test.sh test tests/test_demo.py   # 运行指定测试文件
./run_test.sh ci -n 4                   # 使用4个进程并行
```

## 环境配置

### 支持的环境

| 环境 | 描述 | 测试范围 | 执行方式 | 输出详细度 |
|------|------|----------|----------|------------|
| **dev** (默认) | 开发环境 | 所有测试 | 普通执行 | 详细输出 (`-v`) |
| **test** | 测试环境 | 回归+API测试 | 标记过滤 | 详细输出 (`-v`) |
| **prod** | 生产环境 | 冒烟测试 | 标记过滤 | 简短输出 (`--tb=short`) |
| **ci** | CI环境 | 所有测试 | 并行执行 | 简短输出 (`-n auto --tb=short`) |

### 测试标记说明

```python
@pytest.mark.smoke       # 冒烟测试 - 生产环境执行
@pytest.mark.regression  # 回归测试 - 测试环境执行
@pytest.mark.api         # API测试 - 测试环境执行
@pytest.mark.slow        # 慢速测试 - 开发环境执行
```

## 脚本功能

### 执行流程

1. **依赖同步**：使用 `uv sync --all-groups` 确保所有依赖包已安装
2. **清理报告**：删除 `.report/` 目录下的旧报告
3. **运行测试**：根据环境配置执行相应的测试策略
4. **生成报告**：自动生成 Allure 和 HTML 测试报告
5. **打开报告**：自动在浏览器中打开 Allure 报告

### 环境变量

脚本会根据指定的环境自动设置相应的环境变量：

- `ENV=dev` - 开发环境
- `ENV=test` - 测试环境  
- `ENV=prod` - 生产环境
- `ENV=test` - CI环境（使用test配置）

## 依赖管理

### uv 依赖组

项目使用 uv 的依赖组功能来管理不同类型的依赖：

```toml
[dependency-groups]
# 测试依赖
test = [
    "pytest>=8.4.1",
    "pytest-xdist>=3.8.0",
]

# 测试报告
reports = [
    "allure-pytest>=2.15.0", 
    "pytest-html>=4.1.1",
]
```

### 常用 uv 命令

```bash
# 查看依赖树
uv tree --all-groups

# 查看已安装包
uv pip list

# 添加依赖
uv add <包名>

# 移除依赖
uv remove <包名> --group <组名>
```

## 报告说明

### 报告类型

测试完成后会生成以下报告：

1. **Allure 报告**：`.report/allure-report/index.html`
   - 详细的测试执行报告
   - 支持步骤详情、附件、历史趋势
   - 自动在浏览器中打开

2. **HTML 报告**：`.report/html-reporter/pytest_report.html`
   - pytest 原生HTML报告
   - 包含测试结果和日志信息

### 报告目录结构

```
.report/
├── allure-results/     # Allure原始数据
├── allure-report/      # Allure HTML报告
└── html-reporter/      # pytest HTML报告
```

## 常见用例

### 开发调试

```bash
# 运行特定测试文件
./run_test.sh dev tests/test_demo.py

# 运行特定测试方法
./run_test.sh dev tests/test_demo.py::TestDemo::test_get_demo

# 详细输出模式
./run_test.sh dev -v -s

# 失败时立即停止
./run_test.sh dev --maxfail=1
```

### 生产验证

```bash
# 快速冒烟测试
./run_test.sh prod

# 冒烟测试，失败后立即停止
./run_test.sh prod --maxfail=3
```

### CI/CD集成

```bash
# 并行执行所有测试
./run_test.sh ci

# 指定并行进程数
./run_test.sh ci -n 4

# 严格模式（严格检查标记）
./run_test.sh ci --strict-markers
```

## 配置文件

### pytest 配置

项目的 pytest 配置在 `pyproject.toml` 中：

```toml
[tool.pytest.ini_options]
addopts = [
    "-vs",
    "-rf", 
    "--html=.report/html-reporter/pytest_report.html",
    "--alluredir=.report/allure-results",
    "--clean-alluredir",
]
testpaths = ["tests"]
markers = [
    "smoke: 冒烟测试",
    "regression: 回归测试", 
    "api: API测试",
    "slow: 慢速测试",
]
```

### 环境配置文件

项目支持多环境配置，配置文件位于 `config/` 目录：

- `dev_config.json` - 开发环境配置
- `test_config.json` - 测试环境配置
- `prod_config.json` - 生产环境配置

## 故障排除

### 常见问题

1. **依赖缺失**
   ```bash
   # 重新同步依赖
   uv sync --all-groups
   ```

2. **权限问题**
   ```bash
   # 添加执行权限
   chmod +x run_test.sh
   ```

3. **Allure 报告无法生成**
   ```bash
   # 检查 Allure 是否安装
   allure --version
   
   # 如果未安装，请安装 Allure
   brew install allure  # macOS
   ```

4. **端口冲突**
   ```bash
   # 如果 Allure 服务端口被占用，请手动指定端口
   allure open .report/allure-report --port 8080
   ```

### 日志调试

```bash
# 启用详细日志
./run_test.sh dev -v --tb=long

# 保留测试输出
./run_test.sh dev -s

# 显示最慢的测试
./run_test.sh dev --durations=10
```

## 最佳实践

### 测试编写

1. **使用合适的标记**
   ```python
   @pytest.mark.smoke
   @pytest.mark.api  
   def test_critical_api():
       pass
   ```

2. **环境隔离**
   ```python
   def test_something():
       env = os.getenv('ENV', 'dev')
       if env == 'prod':
           # 生产环境的特殊处理
           pass
   ```

### 执行策略

1. **开发阶段**：使用 `./run_test.sh dev` 运行所有测试
2. **提交前**：使用 `./run_test.sh prod` 确保冒烟测试通过
3. **CI/CD**：使用 `./run_test.sh ci` 进行完整的并行测试
4. **部署验证**：使用 `./run_test.sh prod` 进行生产验证

## 更新历史

- v1.0 - 初始版本，支持多环境测试执行
- v1.1 - 添加 uv 依赖管理支持
- v1.2 - 简化脚本结构，统一为单个主脚本
